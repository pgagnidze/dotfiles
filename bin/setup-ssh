#!/usr/bin/env bash

set -euo pipefail

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

readonly SSH_DIR="$HOME/.ssh"
readonly CONFIG_FILE="$SSH_DIR/config"

log() {
    local level=$1
    shift
    local color
    case "$level" in
        INFO) color="$BLUE" ;;
        SUCCESS) color="$GREEN" ;;
        WARN) color="$YELLOW" ;;
        ERROR) color="$RED" ;;
        *) color="$NC" ;;
    esac
    echo -e "${color}[$level]${NC} $*"
}

show_help() {
    cat << EOF
SSH Key Setup Script

Generates an ed25519 SSH key and configures it for GitHub.

Usage: $(basename "$0") <email> [key_name]

Arguments:
    email       Email address for the key
    key_name    Optional key name (default: derived from email)

Examples:
    $(basename "$0") personal@example.com
    $(basename "$0") work@company.com work

After running this script:
    1. Go to https://github.com/settings/keys
    2. Click "New SSH key"
    3. Paste the public key displayed by this script
    4. Click "Add SSH key"
EOF
}

get_key_name() {
    local email=$1
    local custom_name=${2:-}

    if [[ -n "$custom_name" ]]; then
        echo "$custom_name"
    else
        echo "${email%%@*}"
    fi
}

check_prerequisites() {
    local key_file=$1

    log INFO "Checking prerequisites..."

    if ! command -v ssh-keygen &> /dev/null; then
        log ERROR "ssh-keygen is not installed"
        exit 1
    fi

    if [[ -f "$key_file" ]]; then
        log WARN "SSH key already exists at $key_file"
        read -p "Overwrite? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log INFO "Aborted"
            exit 0
        fi
    fi

    log SUCCESS "Prerequisites check passed"
}

generate_key() {
    local email=$1
    local key_file=$2

    log INFO "Generating ed25519 SSH key for $email..."

    mkdir -p "$SSH_DIR"
    ssh-keygen -t ed25519 -C "$email" -f "$key_file"
    chmod 600 "$key_file"

    log SUCCESS "SSH key generated at $key_file"
}

configure_github() {
    local key_file=$1
    local key_name=$2

    log INFO "Configuring SSH for GitHub..."

    mkdir -p "$SSH_DIR"
    touch "$CONFIG_FILE"

    local host_alias="github.com-${key_name}"

    if grep -q "Host $host_alias" "$CONFIG_FILE" 2>/dev/null; then
        log WARN "SSH configuration for $host_alias already exists"
        return
    fi

    cat >> "$CONFIG_FILE" << EOF

Host $host_alias
    Hostname ssh.github.com
    Port 443
    User git
    IdentityFile $key_file
EOF

    if ! grep -q "Host github.com$" "$CONFIG_FILE" 2>/dev/null; then
        cat >> "$CONFIG_FILE" << EOF

Host github.com
    Hostname ssh.github.com
    Port 443
    User git
    IdentityFile $key_file
EOF
    fi

    log SUCCESS "SSH configuration updated"
}

display_public_key() {
    local key_file=$1

    echo
    log INFO "Your public key:"
    echo
    cat "${key_file}.pub"
    echo
    log WARN "Add this key to GitHub: https://github.com/settings/keys"
    echo
    read -p "Press Enter after adding the key to GitHub..."
}

test_connection() {
    log INFO "Testing SSH connection to GitHub..."
    echo

    if ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
        log SUCCESS "SSH setup complete"
    else
        ssh -T git@github.com || true
        log INFO "If you see 'successfully authenticated', setup is complete"
    fi
}

main() {
    local email=${1:-}

    if [[ -z "$email" || "$email" == "-h" || "$email" == "--help" ]]; then
        show_help
        [[ "$email" == "-h" || "$email" == "--help" ]] && exit 0
        exit 1
    fi

    local key_name
    key_name=$(get_key_name "$email" "${2:-}")

    local key_file="$SSH_DIR/id_ed25519_${key_name}"

    log INFO "Starting SSH setup..."
    log INFO "Key name: $key_name"
    echo

    check_prerequisites "$key_file"
    generate_key "$email" "$key_file"
    configure_github "$key_file" "$key_name"
    display_public_key "$key_file"
    test_connection
}

main "$@"
