#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${DOTFILES_DIR}/config"

CONFIGS=(
    bin
    bash
    git
    ghostty
    nvim
)

setup_colors() {
    if [[ -n "${FORCE_COLOR:-}" ]]; then
        USE_COLOR=true
    elif [[ -n "${NO_COLOR:-}" ]]; then
        USE_COLOR=false
    elif [[ -t 1 ]]; then
        USE_COLOR=true
    else
        USE_COLOR=false
    fi

    if [[ "$USE_COLOR" == true ]]; then
        red=$'\e[31m'
        green=$'\e[32m'
        yellow=$'\e[33m'
        blue=$'\e[34m'
        bold=$'\e[1m'
        reset=$'\e[0m'
    else
        red='' green='' yellow='' blue='' bold='' reset=''
    fi
}

log() {
    local level=$1
    shift
    local color
    case "$level" in
        info) color="$blue" ;;
        success) color="$green" ;;
        warn) color="$yellow" ;;
        error) color="$red" ;;
        *) color="" ;;
    esac
    if [[ "$level" == "error" ]]; then
        echo "${color}[${level}]${reset} $*" >&2
    else
        echo "${color}[${level}]${reset} $*"
    fi
}

show_help() {
    cat <<EOF
${bold}Dotfiles Setup${reset}

Installs dotfiles using GNU Stow with automatic conflict resolution.

Usage: $(basename "$0") [options] [configs...]

Arguments:
    configs         Specific configs to install (default: all)

Options:
    -h, --help      Show this help message

Available configs:
    bin, bash, git, ghostty, nvim

Examples:
    $(basename "$0")              # Install all configs
    $(basename "$0") bash git     # Install specific configs
EOF
}

check_prerequisites() {
    log info "Checking prerequisites"

    if ! command -v stow &>/dev/null; then
        log error "stow is not installed"
        exit 1
    fi

    if ! command -v git &>/dev/null; then
        log error "git is not installed"
        exit 1
    fi

    log success "Prerequisites verified"
}

remove_stale_symlinks() {
    local config=$1
    local config_dir="${CONFIG_DIR}/${config}"

    while IFS= read -r -d '' file; do
        local relative_path="${file#"$config_dir"/}"
        local target_path="${HOME}/${relative_path}"

        if [[ -L "$target_path" ]]; then
            local link_target
            link_target=$(readlink "$target_path")

            local abs_link_target
            if [[ "$link_target" == /* ]]; then
                abs_link_target="$link_target"
            else
                abs_link_target="$(cd "${target_path%/*}" && cd "${link_target%/*}" 2>/dev/null && pwd)/${link_target##*/}" || abs_link_target=""
            fi

            if [[ "$abs_link_target" != "${DOTFILES_DIR}/"* ]]; then
                log warn "Removing stale symlink: $target_path"
                rm "$target_path"
            fi
        fi
    done < <(find "$config_dir" -type f -print0)
}

install_config() {
    local config=$1

    if [[ ! -d "${CONFIG_DIR}/${config}" ]]; then
        log error "Config '$config' not found"
        return 1
    fi

    log info "Installing $config"

    remove_stale_symlinks "$config"

    stow --adopt -v -d "$CONFIG_DIR" -t "$HOME" "$config" 2>&1 | grep -v "^BUG" || true
    git -C "$DOTFILES_DIR" restore "config/$config" 2>/dev/null || true

    log success "$config installed"
}

main() {
    setup_colors

    local configs_to_install=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h | --help)
                show_help
                exit 0
                ;;
            *)
                configs_to_install+=("$1")
                shift
                ;;
        esac
    done

    if [[ ${#configs_to_install[@]} -eq 0 ]]; then
        configs_to_install=("${CONFIGS[@]}")
    fi

    log info "Starting dotfiles installation"
    log info "Dotfiles directory: $DOTFILES_DIR"
    echo

    check_prerequisites
    echo

    log info "Installing ${#configs_to_install[@]} config(s)"

    local success_count=0
    for config in "${configs_to_install[@]}"; do
        if install_config "$config"; then
            success_count=$((success_count + 1))
        fi
    done

    echo
    log success "Installed $success_count/${#configs_to_install[@]} configs"
}

main "$@"
