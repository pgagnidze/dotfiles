#!/usr/bin/env bash

set -euo pipefail

FONT_DIR="$HOME/.local/share/fonts/NerdFonts"
VERSION="v3.3.0"
BASE_URL="https://github.com/ryanoasis/nerd-fonts/releases/download/${VERSION}"

FONTS=(
    CascadiaMono
    JetBrainsMono
    UbuntuMono
)

NOTO_FONTS=(
    NotoSansSymbols
    NotoSansSymbols2
    NotoSansMath
)

setup_colors() {
    if [[ -n "${FORCE_COLOR:-}" ]]; then
        USE_COLOR=true
    elif [[ -n "${NO_COLOR:-}" ]]; then
        USE_COLOR=false
    elif [[ -t 1 ]]; then
        USE_COLOR=true
    else
        USE_COLOR=false
    fi

    if [[ "$USE_COLOR" == true ]]; then
        red=$'\e[31m'
        green=$'\e[32m'
        yellow=$'\e[33m'
        blue=$'\e[34m'
        bold=$'\e[1m'
        reset=$'\e[0m'
    else
        red='' green='' yellow='' blue='' bold='' reset=''
    fi
}

log() {
    local level=$1
    shift
    local color
    case "$level" in
        info) color="$blue" ;;
        success) color="$green" ;;
        warn) color="$yellow" ;;
        error) color="$red" ;;
        *) color="" ;;
    esac
    if [[ "$level" == "error" ]]; then
        echo "${color}[${level}]${reset} $*" >&2
    else
        echo "${color}[${level}]${reset} $*"
    fi
}

show_help() {
    cat <<EOF
${bold}Fonts Installer${reset}

Downloads and installs Nerd Fonts and Noto fonts for terminal and editor use.

Usage: $(basename "$0") [options]

Options:
    -h, --help      Show this help message

Nerd Fonts:
    CascadiaMono, JetBrainsMono, UbuntuMono

Noto Fonts:
    NotoSansSymbols, NotoSansSymbols2, NotoSansMath

Version: $VERSION
Location: $FONT_DIR
EOF
}

check_prerequisites() {
    log info "Checking prerequisites"

    for cmd in curl unzip fc-cache; do
        if ! command -v "$cmd" &>/dev/null; then
            log error "$cmd is not installed"
            exit 1
        fi
    done

    log success "Prerequisites verified"
}

install_fonts() {
    log info "Installing fonts"

    mkdir -p "$FONT_DIR"

    local success_count=0
    local expected=$((${#FONTS[@]} + ${#NOTO_FONTS[@]}))

    for font in "${FONTS[@]}"; do
        log info "Downloading $font"

        if curl -fsSL "${BASE_URL}/${font}.zip" -o "/tmp/${font}.zip"; then
            unzip -oq "/tmp/${font}.zip" -d "$FONT_DIR"
            rm "/tmp/${font}.zip"
            log success "$font installed"
            success_count=$((success_count + 1))
        else
            log error "Failed to download $font"
        fi
    done

    local noto_base_url="https://raw.githubusercontent.com/notofonts/notofonts.github.io/main/fonts"

    for font in "${NOTO_FONTS[@]}"; do
        log info "Downloading $font"
        local font_url="${noto_base_url}/${font}/full/ttf/${font}-Regular.ttf"

        if curl -fsSL "$font_url" -o "$FONT_DIR/${font}-Regular.ttf"; then
            log success "$font installed"
            success_count=$((success_count + 1))
        else
            log error "Failed to download $font"
        fi
    done

    log info "Updating font cache"
    fc-cache -f

    log success "Installed $success_count/$expected fonts"
}

main() {
    setup_colors

    case "${1:-}" in
        -h | --help)
            show_help
            exit 0
            ;;
        "")
            log info "Starting fonts installation"
            echo
            check_prerequisites
            echo
            install_fonts
            ;;
        *)
            log error "Unknown option: $1"
            show_help
            exit 2
            ;;
    esac
    exit 0
}

main "$@"
